<div class="container mt-4">
  <h1 class="text-center mb-4 page-title">üß™ Farm Collaboratif</h1>

  <!-- SECTION 1 : COMPOSANTS √Ä FARM (PRIORIT√â) -->
  <div class="card-htw mb-4">
    <div class="card-header">üåø Composants √† farm (priorit√©)</div>
    <div class="card-body">
      <% if @ingredients_summary.any? %>
        <% @ingredients_summary.each do |ingredient, data| %>
          <div class="ingredient-row mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <strong><%= ingredient.name %></strong>
              <span class="badge badge-<%= data[:status] %>">
                <%= data[:farmed] %>/<%= data[:needed] %> (<%= data[:percentage] %>%)
              </span>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-<%= data[:status] %>"
                   role="progressbar"
                   style="width: <%= data[:percentage] %>%">
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-muted text-center">Aucun consommable s√©lectionn√© pour cette semaine.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 2 : POTIONS CHOISIES PAR LES JOUEURS -->
  <div class="card-htw mb-4">
    <div class="card-header">üìä Consommables s√©lectionn√©s cette semaine</div>
    <div class="card-body">
      <% if @consumable_selections.any? %>
        <div class="row">
          <% @consumable_selections.each do |consumable, selections| %>
            <div class="col-md-6 mb-3">
              <div class="selected-consumable">
                <img src="<%= consumable.icon_image_url %>"
                     alt="<%= consumable.name %>"
                     style="width: 32px; height: 32px; margin-right: 10px;">
                <strong><%= consumable.name %></strong>
                <span class="badge bg-primary ms-2"><%= selections.sum(&:quantity) %>x</span>
                <small class="text-muted">(<%= selections.count %> <%= selections.count > 1 ? 'joueurs' : 'joueur' %>)</small>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-muted text-center">Aucun consommable s√©lectionn√© pour le moment.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 3 : CHOISIR MES CONSOMMABLES -->
  <div class="card-htw mb-4">
    <div class="card-header">üîç Choisir mes consommables</div>
    <div class="card-body">
      <!-- Barre de recherche -->
      <div class="mb-3">
        <input type="text"
               id="consumable-search"
               class="form-control"
               placeholder="üîé Rechercher une potion, flask, food...">
      </div>

      <!-- Liste de tous les consommables (cliquables) -->
      <div id="consumables-list">
        <% @all_consumables.group_by(&:category).each do |category, consumables| %>
          <h5 class="mt-3">
            <%= category == 'flask' ? '‚öóÔ∏è Flasks' : '' %>
            <%= category == 'potion' ? 'üß™ Potions' : '' %>
            <%= category == 'food' ? 'üçñ Food' : '' %>
            <%= category == 'rune' ? 'üíé Runes' : '' %>
          </h5>
          <div class="row">
            <% consumables.each do |consumable| %>
              <div class="col-md-4 col-lg-3 mb-3 consumable-item" data-name="<%= consumable.name.downcase %>">
                <%= form_with url: consumable_selections_path, method: :post, local: true do |f| %>
                  <%= hidden_field_tag :consumable_id, consumable.id %>
                  <button type="submit" class="consumable-button">
                    <img src="<%= consumable.icon_image_url %>"
                         alt="<%= consumable.name %>"
                         style="width: 48px; height: 48px;">
                    <div class="consumable-name"><%= consumable.name %></div>
                  </button>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- SECTION 4 : FORMULAIRE CONTRIBUTION (optionnel) -->
  <div class="card-htw mt-4">
    <div class="card-header">‚ûï J'ai farm√© des composants</div>
    <div class="card-body">
      <%= form_with model: FarmContribution.new, url: farm_contributions_path, local: true, class: "row g-3" do |f| %>
        <div class="col-md-5">
          <%= f.label :ingredient_id, "Ingr√©dient", class: "form-label" %>
          <%= f.collection_select :ingredient_id,
                                   Ingredient.order(:name),
                                   :id,
                                   :name,
                                   { prompt: "-- Choisir --" },
                                   class: "form-control" %>
        </div>

        <div class="col-md-3">
          <%= f.label :quantity, "Quantit√©", class: "form-label" %>
          <%= f.number_field :quantity,
                             class: "form-control",
                             min: 0,
                             placeholder: "Ex: 50" %>
        </div>

        <div class="col-md-4 d-flex align-items-end">
          <%= f.submit "Ajouter", class: "btn btn-success w-100" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Script de recherche en temps r√©el -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('consumable-search');
    const consumableItems = document.querySelectorAll('.consumable-item');

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();

      consumableItems.forEach(function(item) {
        const itemName = item.getAttribute('data-name');
        if (itemName.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });
</script>
