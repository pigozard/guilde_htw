<div class="hw-hero">
  <h1 class="hw-hero-title">ğŸ† Suivi des Hauts Faits</h1>
  <p class="hw-hero-subtitle">Progression et statistiques de votre personnage</p>
</div>

<div class="hw-container">

  <!-- Formulaire de recherche -->
  <div class="hw-card">
    <div class="hw-card-header">
      <span class="hw-card-icon">ğŸ”</span>
      <h2 class="hw-card-title">Rechercher un personnage</h2>
    </div>
    <div class="hw-card-body">
      <%= form_with url: sync_achievements_path, method: :post, local: true do |f| %>
        <div class="hw-achievement-search-form">
          <%= text_field_tag :character_name, @character_name,
                            class: 'hw-form-input',
                            placeholder: 'Nom du personnage',
                            required: true %>
          <%= text_field_tag :realm, @realm,
                            class: 'hw-form-input',
                            placeholder: 'Serveur (ex: Dalaran)',
                            required: true %>
          <%= select_tag :region,
                        options_for_select([['Europe', 'eu'], ['US', 'us'], ['CorÃ©e', 'kr'], ['TaÃ¯wan', 'tw']], @region),
                        class: 'hw-form-select' %>
          <%= submit_tag "ğŸ”„ Synchroniser", class: "hw-btn hw-btn-primary" %>
        </div>
      <% end %>

      <% if @character_name.present? && @user_sync %>
        <div class="hw-achievement-info">
          <strong>ğŸ“Œ Personnage :</strong> <%= @character_name %>-<%= @realm.try(:titleize) %> (<%= @region.upcase %>)
          <small>DerniÃ¨re synchro : <%= @user_sync.synced_at.strftime("%d/%m/%Y Ã  %H:%M") %></small>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Affichage des achievements -->
  <% if @synced_achievements.present? %>

    <!-- VUE D'ENSEMBLE -->
    <% if @view_type == 'overview' %>

      <!-- Extensions -->
      <h2 class="hw-card-title" style="margin: 32px 0 20px 0; font-family: 'Cinzel', serif; color: #f0e6d3; font-size: 22px;">ğŸ“š Extensions</h2>
      <div class="hw-achievement-grid">
        <% @expansion_stats.each do |stat| %>
          <%= link_to achievements_path(view_type: 'expansion', expansion_id: stat[:expansion].id), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title"><%= stat[:expansion].name %></h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= stat[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= stat[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= stat[:percentage] %>%">
                <%= stat[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= stat[:total] %> hauts faits</p>
          <% end %>
        <% end %>
      </div>

      <!-- CatÃ©gories spÃ©ciales -->
      <h2 class="hw-card-title" style="margin: 32px 0 20px 0; font-family: 'Cinzel', serif; color: #f0e6d3; font-size: 22px;">ğŸ¯ CatÃ©gories spÃ©ciales</h2>
      <div class="hw-achievement-grid">

        <% if @pvp_stats && @pvp_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'pvp'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">âš”ï¸ PvP</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @pvp_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @pvp_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @pvp_stats[:percentage] %>%">
                <%= @pvp_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @pvp_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

        <% if @professions_stats && @professions_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'professions'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">ğŸ”¨ MÃ©tiers</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @professions_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @professions_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @professions_stats[:percentage] %>%">
                <%= @professions_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @professions_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

        <% if @collections_stats && @collections_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'collections'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">ğŸ¨ Collections</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @collections_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @collections_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @collections_stats[:percentage] %>%">
                <%= @collections_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @collections_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

        <% if @pets_stats && @pets_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'pets'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">ğŸ¾ Mascottes</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @pets_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @pets_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @pets_stats[:percentage] %>%">
                <%= @pets_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @pets_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

        <% if @exploration_stats && @exploration_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'exploration'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">ğŸ—ºï¸ Exploration</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @exploration_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @exploration_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @exploration_stats[:percentage] %>%">
                <%= @exploration_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @exploration_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

        <% if @events_stats && @events_stats[:total] > 0 %>
          <%= link_to achievements_path(view_type: 'events'), class: "hw-achievement-card" do %>
            <h3 class="hw-achievement-card-title">ğŸ‰ Ã‰vÃ©nements</h3>
            <div class="hw-achievement-stats">
              <span class="hw-achievement-stat-completed">âœ… <%= @events_stats[:completed] %></span>
              <span class="hw-achievement-stat-remaining">âŒ <%= @events_stats[:remaining] %></span>
            </div>
            <div class="hw-achievement-progress">
              <div class="hw-achievement-progress-bar" style="width: <%= @events_stats[:percentage] %>%">
                <%= @events_stats[:percentage] %>%
              </div>
            </div>
            <p class="hw-achievement-total"><%= @events_stats[:total] %> hauts faits</p>
          <% end %>
        <% end %>

      </div>

    <% end %>

    <!-- VUE DÃ‰TAILLÃ‰E : EXTENSION -->
    <% if @view_type == 'expansion' && @selected_expansion %>
      <%= render 'detailed_view',
                 title: @selected_expansion.name,
                 breadcrumb_items: [
                   { label: "Vue d'ensemble", url: achievements_path },
                   { label: @selected_expansion.name, active: true }
                 ],
                 back_url: achievements_path,
                 categories_with_stats: @categories_with_stats,
                 current_stats: @current_stats,
                 achievements: @achievements,
                 base_url_params: { view_type: 'expansion', expansion_id: @selected_expansion.id } %>
    <% end %>

    <!-- VUE DÃ‰TAILLÃ‰E : CATÃ‰GORIES SPÃ‰CIALES -->
    <% if @view_type.in?(['pvp', 'professions', 'pets', 'collections', 'exploration', 'events']) %>
      <%= render 'detailed_view',
                 title: @category_title,
                 breadcrumb_items: [
                   { label: "Vue d'ensemble", url: achievements_path },
                   { label: @category_title, active: true }
                 ],
                 back_url: achievements_path,
                 categories_with_stats: @categories_with_stats,
                 current_stats: @current_stats,
                 achievements: @achievements,
                 base_url_params: { view_type: @view_type } %>
    <% end %>

  <% else %>
    <div class="hw-achievement-empty">
      <h5>ğŸ‘† Entrez un personnage ci-dessus pour commencer</h5>
      <p>Les donnÃ©es seront rÃ©cupÃ©rÃ©es en temps rÃ©el depuis l'API Blizzard.</p>
      <small>
        <strong><%= Achievement.where(is_feat_of_strength: false).count %></strong> hauts faits disponibles
        (hors <%= Achievement.where(is_feat_of_strength: true).count %> Tours de force)
      </small>
    </div>
  <% end %>

</div>
