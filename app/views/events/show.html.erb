<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <!-- Header -->
      <div class="event-header mb-4">
        <span class="event-type-badge event-<%= @event.event_type.gsub('+', '-plus') %>">
          <%= @event.event_type_emoji %> <%= @event.event_type_label %>
        </span>
        <h1 class="mt-3 page-title"><%= @event.title %></h1>
        <p class="text-muted mb-1">ğŸ“… <%= @event.start_time.strftime("%A %d %B %Y Ã  %H:%M") %></p>
        <p class="text-muted mb-1">ğŸ‘¤ CrÃ©Ã© par <%= @event.user.email.split("@").first %></p>
        <% if @event.max_participants %>
          <p class="text-muted mb-1">ğŸ‘¥ <%= @event.confirmed_count %>/<%= @event.max_participants %> places</p>
        <% end %>

        <% if @event.description.present? %>
          <p class="mt-3"><%= @event.description %></p>
        <% end %>

        <% if user_signed_in? && @event.user == current_user %>
          <div class="mt-3">
            <%= link_to edit_event_path(@event), class: "btn btn-outline-light btn-sm" do %>
              âœï¸ Modifier
            <% end %>
            <%= button_to event_path(@event), method: :delete, class: "btn btn-outline-danger btn-sm", data: { confirm: "Supprimer ?" } do %>
              ğŸ—‘ï¸ Supprimer
            <% end %>
          </div>
        <% end %>
      </div>
<!-- Composition -->
      <% if @confirmed.any? %>
        <div class="card-htw mb-4">
          <div class="card-header">ğŸ“Š Composition</div>
          <div class="card-body">
            <div class="d-flex justify-content-around">
              <% roles = @confirmed.map(&:role).compact.tally %>
              <div class="composition-box">
                <div class="icon">ğŸ›¡ï¸</div>
                <div class="count"><%= roles["tank"] || 0 %></div>
                <div class="label">Tanks</div>
              </div>
              <div class="composition-box">
                <div class="icon">ğŸ’š</div>
                <div class="count"><%= roles["healer"] || 0 %></div>
                <div class="label">Heals</div>
              </div>
              <div class="composition-box">
                <div class="icon">âš”ï¸</div>
                <div class="count"><%= roles["dps_cac"] || 0 %></div>
                <div class="label">CAC</div>
              </div>
              <div class="composition-box">
                <div class="icon">ğŸ”®</div>
                <div class="count"><%= roles["dps_caster"] || 0 %></div>
                <div class="label">Casters</div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- ConfirmÃ©s -->
      <div class="card-htw mb-3">
        <div class="card-header header-confirmed">âœ… ConfirmÃ©s (<%= @confirmed.count %>)</div>
        <div class="card-body">
          <% if @confirmed.any? %>
            <div class="row">
              <% @confirmed.each do |p| %>
                <div class="col-md-6">
                  <%= render "participant", p: p %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted mb-0">Personne pour l'instant</p>
          <% end %>
        </div>
      </div>
       <!-- Incertains -->
      <div class="card-htw mb-3">
        <div class="card-header header-tentative">â“ Incertains (<%= @tentative.count %>)</div>
        <div class="card-body">
          <% if @tentative.any? %>
            <% @tentative.each do |p| %>
              <%= render "participant", p: p %>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">Personne</p>
          <% end %>
        </div>
      </div>

      <!-- Absents -->
      <% if @declined.any? %>
        <div class="card-htw mb-4">
          <div class="card-header header-declined">âŒ Absents (<%= @declined.count %>)</div>
          <div class="card-body">
            <% @declined.each do |p| %>
              <%= render "participant", p: p %>
            <% end %>
          </div>
        </div>
      <% end %>
      <!-- Inscription -->
      <% if user_signed_in? && @my_characters.any? %>
        <div class="card-htw mb-4">
          <div class="card-header">ğŸ“ S'inscrire</div>
          <div class="card-body">
            <% @my_characters.each do |character| %>
              <% existing = @event.participation_for(character) %>
              <div class="participation-row">
                <div class="d-flex align-items-center mb-3">
                  <% if character.wow_class&.icon.present? %>
                    <%= image_tag character.wow_class.icon, class: "class-icon me-2" %>
                  <% end %>
                  <strong><%= character.pseudo %></strong>
                  <small class="text-muted ms-2">(<%= character.wow_class&.name || "Flex" %>)</small>
                </div>

                <% if existing %>
                  <%= form_with url: event_event_participation_path(@event, existing), method: :patch, local: true, class: "d-flex align-items-center gap-3 flex-wrap" do %>
                    <% if character.wow_class %>
                      <select name="specialization_id" class="spec-select">
                        <% character.wow_class.specializations.each do |spec| %>
                          <option value="<%= spec.id %>" <%= 'selected' if existing.active_specialization == spec %>>
                            <%= spec.name %> - <%= spec.role %>
                          </option>
                        <% end %>
                      </select>
                    <% end %>
                    <div class="d-flex gap-2">
                      <button type="submit" name="status" value="confirmed" class="btn-status btn-status-success <%= 'active' if existing.status == 'confirmed' %>">âœ…</button>
                      <button type="submit" name="status" value="tentative" class="btn-status btn-status-warning <%= 'active' if existing.status == 'tentative' %>">â“</button>
                      <button type="submit" name="status" value="declined" class="btn-status btn-status-danger <%= 'active' if existing.status == 'declined' %>">âŒ</button>
                    </div>
                  <% end %>
                  <%= button_to event_event_participation_path(@event, existing), method: :delete, class: "btn btn-outline-secondary btn-sm mt-3" do %>
                    Retirer
                  <% end %>
                <% else %>
                  <%= form_with url: event_event_participations_path(@event), method: :post, local: true, class: "d-flex align-items-center gap-3 flex-wrap" do %>
                    <input type="hidden" name="character_id" value="<%= character.id %>">
                    <% if character.wow_class %>
                      <select name="specialization_id" class="spec-select">
                        <% character.wow_class.specializations.each do |spec| %>
                          <option value="<%= spec.id %>" <%= 'selected' if character.specialization == spec %>>
                            <%= spec.name %> - <%= spec.role %>
                          </option>
                        <% end %>
                      </select>
                    <% end %>
                    <div class="d-flex gap-2">
                      <button type="submit" name="status" value="confirmed" class="btn-status btn-status-success">âœ… PrÃ©sent</button>
                      <button type="submit" name="status" value="tentative" class="btn-status btn-status-warning">â“ Incertain</button>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% elsif user_signed_in? %>
        <div class="alert alert-info">
          <%= link_to "CrÃ©e un personnage", new_character_path %> pour t'inscrire.
        </div>
      <% else %>
        <div class="alert alert-info">
          <%= link_to "Connecte-toi", new_user_session_path %> pour t'inscrire.
        </div>
      <% end %>





      <%= link_to events_path, class: "btn btn-outline-light" do %>
        â¬…ï¸ Retour au calendrier
      <% end %>

    </div>
  </div>
</div>
