<div class="container mt-4">
  <h1 class="text-center mb-4 page-title">üß™ Farm Collaboratif</h1>

  <!-- SECTION 1 : COMPOSANTS √Ä FARM -->
  <div class="card-htw mb-4">
    <div class="card-header">üåø Composants √† farm (priorit√©)</div>
    <div class="card-body">
      <% if @ingredients_summary.present? && @ingredients_summary.any? %>
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>Ingr√©dient</th>
                <th class="text-center">Quantit√© n√©cessaire</th>
                <th class="text-center">Qui farm ?</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              <% @ingredients_summary.each do |ingredient, data| %>
                <tr>
                  <td><strong><%= ingredient.name %></strong></td>
                  <td class="text-center">
                    <span class="badge badge-<%= data[:status] %>" style="font-size: 14px;">
                      <%= data[:needed] %>
                    </span>
                  </td>
                  <td class="text-center">
                    <% if data[:farmers].any? %>
                      <% data[:farmers].each do |farmer| %>
                        <span class="badge bg-success me-1">
                          <%= farmer.display_name %>
                          <% if farmer == current_user %>
                            <% assignment = @farmer_assignments.find_by(user: current_user, ingredient: ingredient) %>
                            <% if assignment %>
                              <%= button_to farmer_assignment_path(assignment),
                                  method: :delete,
                                  data: { turbo: false, confirm: "Retirer ton assignment ?" },
                                  form_class: "d-inline",
                                  style: "background: none; border: none; color: white; padding: 0; cursor: pointer; margin-left: 4px;" do %>
                                √ó
                              <% end %>
                            <% end %>
                          <% end %>
                        </span>
                      <% end %>
                    <% else %>
                      <span class="text-muted">Personne</span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if data[:farmers].include?(current_user) %>
                      <span class="text-success">‚úÖ Tu farm √ßa</span>
                    <% else %>
                      <%= form_with url: farmer_assignments_path, method: :post, local: true, data: { turbo: false }, class: "d-inline" do |f| %>
                        <%= hidden_field_tag :ingredient_id, ingredient.id %>
                        <%= f.submit "Je farm √ßa !", class: "btn btn-sm btn-outline-success" %>
                      <% end %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center">Aucun consommable s√©lectionn√© pour cette semaine.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 2 : CONSOMMABLES S√âLECTIONN√âS -->
  <div class="card-htw mb-4">
    <div class="card-header">üìä Consommables s√©lectionn√©s cette semaine</div>
    <div class="card-body">
      <% if @selections_by_consumable.any? %>
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>Consommable</th>
                <th class="text-center">Quantit√© totale</th>
                <th>S√©lectionn√© par</th>
              </tr>
            </thead>
            <tbody>
              <% @selections_by_consumable.each do |consumable, selections| %>
                <tr>
                  <td>
                    <img src="<%= consumable.icon_image_url %>"
                         alt="<%= consumable.name %>"
                         style="width: 32px; height: 32px; margin-right: 10px; border: 2px solid #d4af37; border-radius: 4px;">
                    <strong><%= consumable.name %></strong>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-primary" style="font-size: 16px;">
                      <%= selections.sum(&:quantity) %>x
                    </span>
                  </td>
                  <td>
                    <% selections.each do |selection| %>
                      <div class="d-inline-flex align-items-center me-3 mb-2">
                        <span class="badge bg-secondary" style="font-size: 14px; padding: 8px 10px;">
                          <%= selection.user.display_name %>
                        </span>

                        <% if selection.user == current_user %>
                          <div class="quantity-controls ms-2">
                            <%= button_to consumable_selection_path(selection),
                                method: :patch,
                                params: { action_type: 'decrease' },
                                form_class: 'd-inline',
                                class: 'btn-quantity-control',
                                data: { turbo: false } do %>
                              ‚àí
                            <% end %>

                            <%= form_with url: consumable_selection_path(selection),
                                method: :patch,
                                local: true,
                                data: { turbo: false },
                                class: 'd-inline quantity-input-form' do |f| %>
                              <%= hidden_field_tag :action_type, 'set_quantity' %>
                              <%= number_field_tag :quantity,
                                  selection.quantity,
                                  min: 1,
                                  max: 999,
                                  class: 'quantity-input',
                                  onchange: 'this.form.requestSubmit()' %>
                            <% end %>

                            <%= button_to consumable_selection_path(selection),
                                method: :patch,
                                params: { action_type: 'increase' },
                                form_class: 'd-inline',
                                class: 'btn-quantity-control',
                                data: { turbo: false } do %>
                              +
                            <% end %>

                            <%= button_to consumable_selection_path(selection),
                                method: :delete,
                                data: { turbo: false, confirm: "Retirer compl√®tement ta s√©lection ?" },
                                form_class: "d-inline",
                                class: "btn-remove-selection ms-2",
                                title: "Supprimer" do %>
                              √ó
                            <% end %>
                          </div>
                        <% else %>
                          <span class="ms-2 text-muted"><%= selection.quantity %>x</span>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center">Aucun consommable s√©lectionn√© pour le moment.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 3 : CHOISIR MES CONSOMMABLES -->
  <div class="card-htw mb-4">
    <div class="card-header">üîç Choisir les consommables √† produire</div>
    <div class="card-body">
      <!-- Liste de tous les consommables (cliquables) -->
      <div id="consumables-list">
        <% @all_consumables.group_by(&:category).each do |category, consumables| %>
          <h5 class="mt-4 mb-3 category-title">
            <%= category == 'flask' ? '‚öóÔ∏è Flasks' : '' %>
            <%= category == 'potion' ? 'üß™ Potions' : '' %>
            <%= category == 'food' ? 'üçñ Food' : '' %>
            <%= category == 'rune' ? 'üíé Runes' : '' %>
          </h5>
          <div class="row">
            <% consumables.each do |consumable| %>
              <div class="col-md-3 col-lg-2 mb-3 consumable-item" data-name="<%= consumable.name.downcase %>">
                <%= form_with url: consumable_selections_path, method: :post, local: true, data: { turbo: false } do |f| %>
                  <%= hidden_field_tag :consumable_id, consumable.id %>
                  <button type="submit" class="consumable-button">
                    <img src="<%= consumable.icon_image_url %>"
                         alt="<%= consumable.name %>">
                    <div class="consumable-name"><%= consumable.name %></div>
                  </button>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Script de recherche en temps r√©el -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('consumable-search');
    const consumableItems = document.querySelectorAll('.consumable-item');

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();

      consumableItems.forEach(function(item) {
        const itemName = item.getAttribute('data-name');
        if (itemName.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });
</script>

<!-- Script pour √©viter le scroll en haut -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Emp√™che le scroll lors des soumissions de formulaire
    document.addEventListener('submit', function(e) {
      const form = e.target;
      if (form.closest('.quantity-controls')) {
        e.preventDefault();

        // Sauvegarde la position
        const scrollPos = window.scrollY;

        // Soumet le formulaire
        fetch(form.action, {
          method: form.method,
          body: new FormData(form),
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        }).then(() => {
          // Recharge la page
          window.location.reload();

          // Restaure la position apr√®s rechargement
          window.addEventListener('load', function() {
            window.scrollTo(0, scrollPos);
          }, { once: true });
        });
      }
    });
  });
</script>
