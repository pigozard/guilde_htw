<div class="hw-hero">
  <h1 class="hw-hero-title">üß™ Farm Collaboratif</h1>
  <p class="hw-hero-subtitle">Organisez la production de consommables</p>
</div>

<div class="hw-container">

  <!-- SECTION 1 : COMPOSANTS √Ä FARM -->
  <div class="hw-card">
    <div class="hw-card-header">
      <span class="hw-card-icon">üåø</span>
      <h2 class="hw-card-title">Composants √† farm (priorit√©)</h2>
    </div>
    <div class="hw-card-body">
      <% if @ingredients_summary.present? && @ingredients_summary.any? %>
        <div class="hw-table-wrapper">
          <table class="hw-farm-table">
            <thead>
              <tr>
                <th>Ingr√©dient</th>
                <th class="text-center">Quantit√© n√©cessaire</th>
                <th class="text-center">Qui farm ?</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              <% @ingredients_summary.each do |ingredient, data| %>
                <tr>
                  <td><strong><%= ingredient.name %></strong></td>
                  <td class="text-center">
                    <span class="hw-badge hw-badge-<%= data[:status] %> hw-badge-lg">
                      <%= data[:needed] %>
                    </span>
                  </td>
                  <td class="text-center">
                    <% if data[:farmers].any? %>
                      <% data[:farmers].each do |farmer| %>
                        <span class="hw-farmer-badge">
                          <%= farmer.display_name %>
                          <% if farmer == current_user %>
                            <% assignment = @farmer_assignments.find_by(user: current_user, ingredient: ingredient) %>
                            <% if assignment %>
                              <%= button_to farmer_assignment_path(assignment),
                                  method: :delete,
                                  data: { turbo: false, confirm: "Retirer ton assignment ?" },
                                  class: "hw-farmer-remove" do %>
                                √ó
                              <% end %>
                            <% end %>
                          <% end %>
                        </span>
                      <% end %>
                    <% else %>
                      <span style="color: #666;">Personne</span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if data[:farmers].include?(current_user) %>
                      <span style="color: #81c784;">‚úÖ Tu farm √ßa</span>
                    <% else %>
                      <%= form_with url: farmer_assignments_path, method: :post, local: true, data: { turbo: false }, class: "d-inline" do |f| %>
                        <%= hidden_field_tag :ingredient_id, ingredient.id %>
                        <%= f.submit "Je farm √ßa !", class: "hw-btn hw-btn-primary hw-btn-sm" %>
                      <% end %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="hw-farm-empty">Aucun consommable s√©lectionn√© pour cette semaine.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 2 : CONSOMMABLES S√âLECTIONN√âS -->
  <div class="hw-card">
    <div class="hw-card-header">
      <span class="hw-card-icon">üìä</span>
      <h2 class="hw-card-title">Consommables s√©lectionn√©s cette semaine</h2>
    </div>
    <div class="hw-card-body">
      <% if @selections_by_consumable.any? %>
        <div class="hw-table-wrapper">
          <table class="hw-farm-table">
            <thead>
              <tr>
                <th>Consommable</th>
                <th class="text-center">Quantit√© totale</th>
                <th>S√©lectionn√© par</th>
              </tr>
            </thead>
            <tbody>
              <% @selections_by_consumable.each do |consumable, selections| %>
                <tr>
                  <td>
                    <div class="hw-farm-consumable-cell">
                      <%= image_tag consumable.icon_image_url, alt: consumable.name, class: "hw-farm-consumable-icon" %>
                      <strong><%= consumable.name %></strong>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="hw-badge hw-badge-primary hw-badge-lg">
                      <%= selections.sum(&:quantity) %>x
                    </span>
                  </td>
                  <td>
                    <% selections.each do |selection| %>
                      <div class="hw-user-selection">
                        <span class="hw-user-badge">
                          <%= selection.user.display_name %>
                        </span>

                        <% if selection.user == current_user %>
                          <div class="hw-quantity-controls">
                            <%= button_to consumable_selection_path(selection),
                                method: :patch,
                                params: { action_type: 'decrease' },
                                class: 'hw-quantity-btn',
                                data: { turbo: false } do %>
                              ‚àí
                            <% end %>

                            <%= form_with url: consumable_selection_path(selection),
                                method: :patch,
                                local: true,
                                data: { turbo: false },
                                class: 'd-inline' do |f| %>
                              <%= hidden_field_tag :action_type, 'set_quantity' %>
                              <%= number_field_tag :quantity,
                                  selection.quantity,
                                  min: 1,
                                  max: 999,
                                  class: 'hw-quantity-input',
                                  onchange: 'this.form.requestSubmit()' %>
                            <% end %>

                            <%= button_to consumable_selection_path(selection),
                                method: :patch,
                                params: { action_type: 'increase' },
                                class: 'hw-quantity-btn',
                                data: { turbo: false } do %>
                              +
                            <% end %>

                            <%= button_to consumable_selection_path(selection),
                                method: :delete,
                                data: { turbo: false, confirm: "Retirer compl√®tement ta s√©lection ?" },
                                class: "hw-quantity-remove",
                                title: "Supprimer" do %>
                              √ó
                            <% end %>
                          </div>
                        <% else %>
                          <span style="color: #888; margin-left: 8px;"><%= selection.quantity %>x</span>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="hw-farm-empty">Aucun consommable s√©lectionn√© pour le moment.</p>
      <% end %>
    </div>
  </div>

  <!-- SECTION 3 : CHOISIR MES CONSOMMABLES -->
  <div class="hw-card">
    <div class="hw-card-header">
      <span class="hw-card-icon">üîç</span>
      <h2 class="hw-card-title">Choisir les consommables √† produire</h2>
    </div>
    <div class="hw-card-body">
      <% @all_consumables.group_by(&:category).each do |category, consumables| %>
        <h3 class="hw-farm-category-title">
          <%= category == 'flask' ? '‚öóÔ∏è Flasks' : '' %>
          <%= category == 'potion' ? 'üß™ Potions' : '' %>
          <%= category == 'food' ? 'üçñ Food' : '' %>
          <%= category == 'rune' ? 'üíé Runes' : '' %>
        </h3>
        <div class="hw-consumables-grid">
          <% consumables.each do |consumable| %>
            <div class="hw-consumable-item" data-name="<%= consumable.name.downcase %>">
              <%= form_with url: consumable_selections_path, method: :post, local: true, data: { turbo: false } do |f| %>
                <%= hidden_field_tag :consumable_id, consumable.id %>
                <button type="submit" class="hw-consumable-button">
                  <%= image_tag consumable.icon_image_url, alt: consumable.name %>
                  <div class="hw-consumable-name"><%= consumable.name %></div>
                </button>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

</div>
