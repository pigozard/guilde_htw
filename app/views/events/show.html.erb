


<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <!-- Header -->
      <div class="event-header mb-4">
        <span class="event-type-badge event-<%= @event.event_type.gsub('+', '-plus') %>">
          <%= @event.event_type_emoji %> <%= @event.event_type_label %>
        </span>
        <h1 class="mt-3 page-title"><%= @event.title %></h1>
        <p class="text-muted mb-1">üìÖ <%= @event.start_time.strftime("%A %d %B %Y √† %H:%M") %></p>
        <p class="text-muted mb-1">üë§ Cr√©√© par <%= @event.user.email.split("@").first %></p>
        <% if @event.max_participants %>
          <p class="text-muted mb-1">üë• <%= @event.confirmed_count %>/<%= @event.max_participants %> places</p>
        <% end %>

        <% if @event.description.present? %>
          <p class="mt-3"><%= @event.description %></p>
        <% end %>

        <% if user_signed_in? && @event.user == current_user %>
          <div class="mt-3">
            <%= link_to edit_event_path(@event), class: "btn btn-outline-light btn-sm" do %>
              ‚úèÔ∏è Modifier
            <% end %>
            <%= button_to event_path(@event), method: :delete, class: "btn btn-outline-danger btn-sm", data: { confirm: "Supprimer ?" } do %>
              üóëÔ∏è Supprimer
            <% end %>
          </div>
        <% end %>
      </div>

    <!-- Composition -->
<% if @confirmed.any? %>
  <div class="card-htw mb-4">
    <div class="card-header">üìä Composition</div>
    <div class="card-body">
      <div class="composition-grid">
        <% roles = @confirmed.map(&:role).compact.tally %>
        <div class="composition-box">
          <%= image_tag "roles/tank.png", class: "role-icon-big" %>
          <div class="count"><%= roles["tank"] || 0 %></div>
          <div class="label">Tanks</div>
        </div>
        <div class="composition-box">
          <%= image_tag "roles/healer.png", class: "role-icon-big" %>
          <div class="count"><%= roles["healer"] || 0 %></div>
          <div class="label">Heals</div>
        </div>
        <div class="composition-box">
          <%= image_tag "roles/dps_cac.png", class: "role-icon-big" %>
          <div class="count"><%= roles["dps_cac"] || 0 %></div>
          <div class="label">CAC</div>
        </div>
        <div class="composition-box">
          <%= image_tag "roles/dps_caster.png", class: "role-icon-big" %>
          <div class="count"><%= roles["dps_caster"] || 0 %></div>
          <div class="label">Casters</div>
        </div>
      </div>
    </div>
  </div>
<% end %>
      <!-- Confirm√©s -->
      <div class="card-htw mb-3">
        <div class="card-header header-confirmed">‚úÖ Confirm√©s (<%= @confirmed.count %>)</div>
        <div class="card-body">
          <% if @confirmed.any? %>
            <div class="row">
              <% @confirmed.each do |p| %>
                <div class="col-md-6">
                  <%= render "participant_card", p: p %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted mb-0">Personne pour l'instant</p>
          <% end %>
        </div>
      </div>

      <!-- Incertains -->
      <div class="card-htw mb-3">
        <div class="card-header header-tentative">‚ùì Incertains (<%= @tentative.count %>)</div>
        <div class="card-body">
          <% if @tentative.any? %>
            <div class="row">
              <% @tentative.each do |p| %>
                <div class="col-md-6">
                  <%= render "participant_card", p: p %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted mb-0">Personne</p>
          <% end %>
        </div>
      </div>

      <!-- Absents -->
      <% if @declined.any? %>
        <div class="card-htw mb-4">
          <div class="card-header header-declined">‚ùå Absents (<%= @declined.count %>)</div>
          <div class="card-body">
            <div class="row">
              <% @declined.each do |p| %>
                <div class="col-md-6">
                  <%= render "participant_card", p: p %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

     <!-- Inscription -->
<% if user_signed_in? %>
  <div class="card-htw mb-4">
    <div class="card-header">üìù S'inscrire</div>
    <div class="card-body">
      <% characters_to_show = @my_characters.reject { |c| c.wow_class.nil? || c.wow_class.name == "Flex" } %>

      <% if characters_to_show.any? %>
        <% characters_to_show.each do |character| %>
          <%= render "signup_form", character: character, event: @event %>
        <% end %>
      <% end %>

      <div class="add-character-section">
        <a href="#" class="btn-add-character" onclick="document.getElementById('temp-character-form').classList.toggle('d-none'); return false;">
          ‚ûï Jouer un autre perso
        </a>

        <div id="temp-character-form" class="temp-form d-none">
          <%= form_with url: event_event_participations_path(@event), method: :post, local: true do %>
            <input type="hidden" name="temporary" value="true">

            <div class="temp-form-row">
              <input type="text" name="pseudo" placeholder="Pseudo" class="form-control" required>

              <select name="wow_class_id" id="temp-class-select" class="form-control" required>
                <option value="">-- Classe --</option>
                <% WowClass.where.not(name: "Flex").each do |wc| %>
                  <option value="<%= wc.id %>"><%= wc.name %></option>
                <% end %>
              </select>

              <select name="specialization_id" id="temp-spec-select" class="form-control" required>
                <option value="">-- Sp√© --</option>
              </select>

              <button type="submit" name="status" value="confirmed" class="btn-status btn-status-success">‚úÖ</button>
              <button type="submit" name="status" value="tentative" class="btn-status btn-status-warning">‚ùì</button>
            </div>
          <% end %>
        </div>
      </div>
      <script>
  document.getElementById('temp-class-select')?.addEventListener('change', function() {
    const classId = this.value;
    const specSelect = document.getElementById('temp-spec-select');
    specSelect.innerHTML = '<option value="">-- Sp√© --</option>';

    if (classId) {
      fetch(`/wow_classes/${classId}/specializations.json`)
        .then(response => response.json())
        .then(specs => {
          specs.forEach(spec => {
            const option = document.createElement('option');
            option.value = spec.id;
            option.textContent = spec.name;
            specSelect.appendChild(option);
          });
        });
    }
  });
</script>
    </div>
  </div>
<% else %>
  <div class="alert-info-htw">
    <%= link_to "Connecte-toi", new_user_session_path %> pour t'inscrire.
  </div>
<% end %>
